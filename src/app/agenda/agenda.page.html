<ion-content [fullscreen]="true" class="agenda-content">
  <div class="pb-20">
    <!-- Header -->
    <div class="header-gradient">
      <h2 class="header-title">Schedule</h2>
      <img src="assets/calig.png" alt="" class="header-overlay" />

      <!-- Search Bar -->
      <div class="search-container">
        <ion-icon name="search-outline" class="search-icon"></ion-icon>
        <input 
          type="text"
          placeholder="Search..."
          class="search-input"
          [(ngModel)]="searchQuery"
          (input)="onSearchChange(searchQuery)"
        />
        <button 
          *ngIf="searchQuery"
          class="clear-search-btn"
          (click)="clearSearch()">
          <ion-icon name="close-circle"></ion-icon>
        </button>
      </div>
    </div>

    <!-- Day Selector - Floating Tabs -->
    <div class="day-selector">
      <div class="day-selector-wrapper">
        <button
          *ngFor="let day of ['1', '2', '3']"
          class="day-btn"
          [class.active]="selectedDay === day"
          (click)="setSelectedDay(day)">
          Day {{day}}
        </button>
      </div>
    </div>

    <!-- Sessions List -->
    <div class="sessions-container">
      <ng-container *ngIf="filteredSessions.length > 0; else noSessions">
        <div
          *ngFor="let session of filteredSessions"
          class="session-card"
          #sessionCard
          [id]="session.id"
          [style.border-left-color]="session.color">
          
          <!-- Session Time Badge -->
          <div class="time-badge" [style.background-color]="session.color">
            <ion-icon name="time-outline" class="time-icon"></ion-icon>
            {{ session.startTime.toDate() | date:'shortTime' }}
          </div>

          <!-- Session Content -->
          <div class="session-content">
            <!-- Category Tag -->
            <div class="session-tags">
              <span class="category-tag" [style.background-color]="session.color + '20'" [style.color]="session.color">
                {{ formatCategory(session.category) }}
              </span>
            </div>

            <!-- Title -->
            <h3 class="session-title">{{ session.title }}</h3>

            <!-- Speaker Info -->
            <div class="speaker-info" *ngIf="session.speaker?.name && session.speaker?.name?.toLowerCase() !== 'all'">
              <div class="speaker-avatar" *ngIf="!session.speaker?.photoURL || session.speaker?.photoURL === 'null'">
                {{ session.speaker?.name?.[0] || '' }}{{ (session.speaker?.name?.split(' ')?.[1] || '')?.[0] || '' }}
              </div>
              <img *ngIf="session.speaker?.photoURL && session.speaker?.photoURL !== 'null'"
                   [src]="session.speaker?.photoURL"
                   alt="{{ session.speaker?.name }}"
                   class="speaker-avatar-img" />
              <div class="speaker-details">
                <div class="speaker-label">Speaker</div>
                <div class="speaker-name">{{ session.speaker?.name }}</div>
                <div class="speaker-role">{{ session.speaker?.title }}</div>
              </div>
            </div>

            <!-- Session Meta Info -->
            <div class="session-meta-grid">
              <div class="meta-card">
                <ion-icon name="time-outline" class="meta-icon"></ion-icon>
                <div class="meta-content">
                  <div class="meta-label">Duration</div>
                  <div class="meta-value">{{ formatSessionTime(session) }}</div>
                </div>
              </div>
              
              <div class="meta-card">
                <ion-icon name="location-outline" class="meta-icon"></ion-icon>
                <div class="meta-content">
                  <div class="meta-label">Location</div>
                  <div class="meta-value">{{ session.location }}</div>
                </div>
              </div>
            </div>

            <!-- Materials Section -->
            <div class="materials-section" *ngIf="hasMaterial(session)">
              <div class="materials-header">
                <div class="materials-title">
                  <ion-icon name="folder-outline" class="folder-icon"></ion-icon>
                  <span>Attachment</span>
                </div>
              </div>
              
              <div class="materials-grid">
                <div
                  class="material-card"
                  (click)="viewMaterial(session)">
                  <div class="material-icon-wrapper" [style.background-color]="session.color + '15'">
                    <ion-icon [name]="getMaterialIcon(getMaterialType(session.material!))" 
                              class="material-icon"
                              [style.color]="session.color"></ion-icon>
                  </div>
                  <div class="material-info">
                    <div class="material-name">{{ session.title }}</div>
                    <div class="material-meta">
                      <span class="material-type">{{ getMaterialType(session.material!) }}</span>
                    </div>
                  </div>
                  <button 
                    class="material-download-btn"
                    (click)="downloadMaterial($event, session)"
                    [style.color]="session.color">
                    <ion-icon name="download-outline"></ion-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- No Sessions Message -->
      <ng-template #noSessions>
        <div class="no-sessions">
          <div class="no-sessions-icon">
            <ion-icon name="calendar-clear-outline"></ion-icon>
          </div>
          <h3 class="no-sessions-title">
            {{ searchQuery ? 'No Results Found' : 'No Sessions Scheduled' }}
          </h3>
          <p class="no-sessions-text">
            <ng-container *ngIf="searchQuery; else noSearchMessage">
              No sessions match your search "{{ searchQuery }}".<br>
              Try different keywords or <button class="inline-clear-btn" (click)="clearSearch()">clear your search</button>.
            </ng-container>
            <ng-template #noSearchMessage>
              There are no sessions scheduled for Day {{ selectedDay }}.<br>
              Check other days or come back later for updates!
            </ng-template>
          </p>
        </div>
      </ng-template>
    </div>

    <!-- Material Viewer Modal -->
    <ion-modal
      [isOpen]="showMaterialViewer"
      (didDismiss)="closeMaterialViewer()"
      class="material-modal">
      <ng-template>
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <div class="modal-title">
              <ion-icon [name]="getMaterialIcon(selectedMaterial?.type || '')"></ion-icon>
              <span>{{ selectedMaterial?.name }}</span>
            </div>
            <div class="modal-actions">
              <button class="modal-action-btn" (click)="downloadCurrentMaterial()">
                <ion-icon name="download-outline"></ion-icon>
              </button>
              <button class="modal-action-btn" (click)="closeMaterialViewer()">
                <ion-icon name="close-outline"></ion-icon>
              </button>
            </div>
          </div>

          <!-- Material Viewer -->
          <div class="modal-body">
            <ng-container *ngIf="selectedMaterial">
              <!-- PDF Viewer -->
              <iframe
                *ngIf="selectedMaterial.type === 'PDF'"
                [src]="sanitizeUrl(selectedMaterial.url)"
                class="material-iframe"
                allow="fullscreen; picture-in-picture"
                allowfullscreen>
              </iframe>

              <!-- Image Viewer -->
              <img
                *ngIf="selectedMaterial.type === 'Image'"
                [src]="selectedMaterial.url"
                [alt]="selectedMaterial.name"
                class="material-image">

              <!-- Video Viewer -->
              <video
                *ngIf="selectedMaterial.type === 'Video'"
                [src]="selectedMaterial.url"
                controls
                controlsList="nodownload"
                class="material-video">
                Your browser does not support the video tag.
              </video>

              <!-- Document/Spreadsheet Viewer -->
<iframe
  *ngIf="selectedMaterial.type === 'Document' || selectedMaterial.type === 'Spreadsheet' || selectedMaterial.type === 'Presentation'"
  [src]="sanitizeUrl(selectedMaterial.url)"
  class="material-iframe"
  allow="fullscreen">
</iframe>
  <div class="pb-20">
    <!-- Header -->
    <div class="header-gradient">
      <h2 class="header-title">Schedule</h2>
      <img src="assets/calig.png" alt="" class="header-overlay" />

      <!-- Search Bar -->
      <div class="search-container">
        <ion-icon name="search-outline" class="search-icon"></ion-icon>
        <input 
          type="text"
          placeholder="Search..."
          class="search-input"
          [(ngModel)]="searchQuery"
          (input)="onSearchChange(searchQuery)"
        />
        <button 
          *ngIf="searchQuery"
          class="clear-search-btn"
          (click)="clearSearch()">
          <ion-icon name="close-circle"></ion-icon>
        </button>
      </div>
    </div>

    <!-- Day Selector - Floating Tabs -->
    <div class="day-selector">
      <div class="day-selector-wrapper">
        <button
          *ngFor="let day of ['1', '2', '3']"
          class="day-btn"
          [class.active]="selectedDay === day"
          (click)="setSelectedDay(day)">
          Day {{day}}
        </button>
      </div>
    </div>

    <!-- Sessions List -->
    <div class="sessions-container">
      <ng-container *ngIf="filteredSessions.length > 0; else noSessions">
        <div
          *ngFor="let session of filteredSessions"
          class="session-card"
          #sessionCard
          [id]="session.id"
          [style.border-left-color]="session.color">
          
          <!-- Session Time Badge -->
          <div class="time-badge" [style.background-color]="session.color">
            <ion-icon name="time-outline" class="time-icon"></ion-icon>
            {{ session.startTime.toDate() | date:'shortTime' }}
          </div>

          <!-- Session Content -->
          <div class="session-content">
            <!-- Category Tag -->
            <div class="session-tags">
              <span class="category-tag" [style.background-color]="session.color + '20'" [style.color]="session.color">
                {{ formatCategory(session.category) }}
              </span>
            </div>

            <!-- Title -->
            <h3 class="session-title">{{ session.title }}</h3>

            <!-- Speaker Info -->
            <div class="speaker-info" *ngIf="session.speaker?.name && session.speaker?.name?.toLowerCase() !== 'all'">
              <div class="speaker-avatar" *ngIf="!session.speaker?.photoURL || session.speaker?.photoURL === 'null'">
                {{ session.speaker?.name?.[0] || '' }}{{ (session.speaker?.name?.split(' ')?.[1] || '')?.[0] || '' }}
              </div>
              <img *ngIf="session.speaker?.photoURL && session.speaker?.photoURL !== 'null'"
                   [src]="session.speaker?.photoURL"
                   alt="{{ session.speaker?.name }}"
                   class="speaker-avatar-img" />
              <div class="speaker-details">
                <div class="speaker-label">Speaker</div>
                <div class="speaker-name">{{ session.speaker?.name }}</div>
                <div class="speaker-role">{{ session.speaker?.title }}</div>
              </div>
            </div>

            <!-- Session Meta Info -->
            <div class="session-meta-grid">
              <div class="meta-card">
                <ion-icon name="time-outline" class="meta-icon"></ion-icon>
                <div class="meta-content">
                  <div class="meta-label">Duration</div>
                  <div class="meta-value">{{ formatSessionTime(session) }}</div>
                </div>
              </div>
              
              <div class="meta-card">
                <ion-icon name="location-outline" class="meta-icon"></ion-icon>
                <div class="meta-content">
                  <div class="meta-label">Location</div>
                  <div class="meta-value">{{ session.location }}</div>
                </div>
              </div>
            </div>

            <!-- Materials Section -->
            <div class="materials-section" *ngIf="hasMaterial(session)">
              <div class="materials-header">
                <div class="materials-title">
                  <ion-icon name="folder-outline" class="folder-icon"></ion-icon>
                  <span>Attachment</span>
                </div>
              </div>
              
              <div class="materials-grid">
                <div
                  class="material-card"
                  (click)="viewMaterial(session)">
                  <div class="material-icon-wrapper" [style.background-color]="session.color + '15'">
                    <ion-icon [name]="getMaterialIcon(getMaterialType(session.material!))" 
                              class="material-icon"
                              [style.color]="session.color"></ion-icon>
                  </div>
                  <div class="material-info">
                    <div class="material-name">{{ session.title }}</div>
                    <div class="material-meta">
                      <span class="material-type">{{ getMaterialType(session.material!) }}</span>
                    </div>
                  </div>
                  <button 
                    class="material-download-btn"
                    (click)="downloadMaterial($event, session)"
                    [style.color]="session.color">
                    <ion-icon name="download-outline"></ion-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- No Sessions Message -->
      <ng-template #noSessions>
        <div class="no-sessions">
          <div class="no-sessions-icon">
            <ion-icon name="calendar-clear-outline"></ion-icon>
          </div>
          <h3 class="no-sessions-title">
            {{ searchQuery ? 'No Results Found' : 'No Sessions Scheduled' }}
          </h3>
          <p class="no-sessions-text">
            <ng-container *ngIf="searchQuery; else noSearchMessage">
              No sessions match your search "{{ searchQuery }}".<br>
              Try different keywords or <button class="inline-clear-btn" (click)="clearSearch()">clear your search</button>.
            </ng-container>
            <ng-template #noSearchMessage>
              There are no sessions scheduled for Day {{ selectedDay }}.<br>
              Check other days or come back later for updates!
            </ng-template>
          </p>
        </div>
      </ng-template>
    </div>

    <!-- Material Viewer Modal -->
    <ion-modal
      [isOpen]="showMaterialViewer"
      (didDismiss)="closeMaterialViewer()"
      class="material-modal">
      <ng-template>
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <div class="modal-title">
              <ion-icon [name]="getMaterialIcon(selectedMaterial?.type || '')"></ion-icon>
              <span>{{ selectedMaterial?.name }}</span>
            </div>
            <div class="modal-actions">
              <button class="modal-action-btn" (click)="downloadCurrentMaterial()">
                <ion-icon name="download-outline"></ion-icon>
              </button>
              <button class="modal-action-btn" (click)="closeMaterialViewer()">
                <ion-icon name="close-outline"></ion-icon>
              </button>
            </div>
          </div>

          <!-- Material Viewer -->
          <div class="modal-body">
            <ng-container *ngIf="selectedMaterial">
              <!-- PDF Viewer -->
              <iframe
                *ngIf="selectedMaterial.type === 'PDF'"
                [src]="sanitizeUrl(selectedMaterial.url + '#toolbar=1')"
                class="material-iframe"
                allow="fullscreen">
              </iframe>

              <!-- Image Viewer -->
              <img
                *ngIf="selectedMaterial.type === 'Image'"
                [src]="selectedMaterial.url"
                [alt]="selectedMaterial.name"
                class="material-image">

              <!-- Video Viewer -->
              <video
                *ngIf="selectedMaterial.type === 'Video'"
                [src]="selectedMaterial.url"
                controls
                controlsList="nodownload"
                class="material-video">
                Your browser does not support the video tag.
              </video>

              <!-- Document/Spreadsheet Viewer -->
              <iframe
                *ngIf="selectedMaterial.type === 'Document' || selectedMaterial.type === 'Spreadsheet' || selectedMaterial.type === 'Presentation'"
                [src]="sanitizeUrl(selectedMaterial.url)"
                class="material-iframe"
                allow="fullscreen">
              </iframe>

              <!-- Fallback for unsupported types -->
              <div *ngIf="!['PDF', 'Image', 'Video', 'Document', 'Spreadsheet', 'Presentation'].includes(selectedMaterial.type)" 
                   class="unsupported-type">
                <ion-icon name="alert-circle-outline"></ion-icon>
                <p>Preview not available for this file type</p>
                <button class="download-btn" (click)="downloadCurrentMaterial()">
                  <ion-icon name="download-outline"></ion-icon>
                  Download File
                </button>
              </div>
            </ng-container>
          </div>
        </div>
      </ng-template>
    </ion-modal>
  </div>
